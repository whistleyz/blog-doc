<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.jpg" />
    <link rel="stylesheet" href="/umi.79bb87e3.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.3.3
    </script>
    <title>深入了解 vue 响应式原理</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/principle/reactive_vue" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.jpg&#x27;)" href="/">blog-doc</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/summary">Summary</a></span><span><a href="/practice">Practice</a></span><span><a aria-current="page" class="active" href="/principle">Principle</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/whistleyz">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.jpg&#x27;)" href="/"></a><h1>blog-doc</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/summary">Summary</a></li><li><a href="/practice">Practice</a></li><li><a aria-current="page" class="active" href="/principle">Principle</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/whistleyz">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">Front</a><ul><li><a aria-current="page" class="active" href="/principle/reactive_vue"><span>深入了解 vue 响应式原理</span></a></li><li><a href="/principle/state_manager"><span>实现一个前端状态管理器</span></a></li><li><a href="/principle/vue_computed"><span>Vue computed 与记忆函数</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">ECMAScript</a><ul><li><a href="/principle/promise"><span>Promise 规范与实现</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="概述" data-depth="2"><a href="/principle/reactive_vue#概述"><span>概述</span></a></li><li title="什么是对象劫持？" data-depth="3"><a href="/principle/reactive_vue#什么是对象劫持？"><span>什么是对象劫持？</span></a></li><li title="怎么劫持？" data-depth="3"><a href="/principle/reactive_vue#怎么劫持？"><span>怎么劫持？</span></a></li><li title="深入" data-depth="2"><a href="/principle/reactive_vue#深入"><span>深入</span></a></li><li title="Object.defineProperty 的局限" data-depth="3"><a href="/principle/reactive_vue#objectdefineproperty-的局限"><span>Object.defineProperty 的局限</span></a></li><li title="Proxy" data-depth="3"><a href="/principle/reactive_vue#proxy"><span>Proxy</span></a></li><li title="Vue 原理" data-depth="2"><a href="/principle/reactive_vue#vue-原理"><span>Vue 原理</span></a></li><li title="Vue2 响应式原理" data-depth="3"><a href="/principle/reactive_vue#vue2-响应式原理"><span>Vue2 响应式原理</span></a></li><li title="细节处理" data-depth="3"><a href="/principle/reactive_vue#细节处理"><span>细节处理</span></a></li><li title="对数组的处理" data-depth="3"><a href="/principle/reactive_vue#对数组的处理"><span>对数组的处理</span></a></li><li title="Proxy 在 Vue3 中的运用" data-depth="3"><a href="/principle/reactive_vue#proxy-在-vue3-中的运用"><span>Proxy 在 Vue3 中的运用</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="深入了解-vue-响应式原理"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#深入了解-vue-响应式原理"><span class="icon,icon-link"></span></a>深入了解 vue 响应式原理</h1><h2 id="概述"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#概述"><span class="icon,icon-link"></span></a>概述</h2><p>vue 的响应式原理主要从三个角度来理解：数据劫持、依赖收集和异步更新。通过对象劫持来做 依赖的收集 和 数据变化的侦测，维持一个队列来异步更新视图。</p><h3 id="什么是对象劫持？"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#什么是对象劫持？"><span class="icon,icon-link"></span></a>什么是对象劫持？</h3><p>在 JavaScript 中，对象作为一种 key/value 键值对的形式存在，而对对象的基本会有 增、删、改、查 的基本操作：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> dog </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;dog&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  single</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  girlFriend</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;charm&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  house</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;villa&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">delete</span><span class="token plain"> dog</span><span class="token punctuation">.</span><span class="token property-access">house</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">dog</span><span class="token punctuation">.</span><span class="token property-access">single</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">dog</span><span class="token punctuation">.</span><span class="token property-access">character</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;easy&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">delete</span><span class="token plain"> dog</span><span class="token punctuation">.</span><span class="token property-access">girlFriend</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">dog</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面的操作是低效的，当删除 dog 的 house 属性，single 属性应该自动被设置为 true。通过数据劫持，可以通过拦截某个属性的修改操作，进而去处理这个改变应该触发的其他值、状态的更新。</p><p>那么先来看看</p><h3 id="怎么劫持？"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#怎么劫持？"><span class="icon,icon-link"></span></a>怎么劫持？</h3><p>主要是通过 <code>Object.defineProperty</code> 方法来实现。举个小例子：“如果一个穷小子，有房子就有女朋友，房子没了，那么女朋友也就没了”</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> dog </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;dog&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  single</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  girlFriend</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">_house </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token plain">dog</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;house&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  configurable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> _house</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">set</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">house</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">house</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _house </span><span class="token operator">=</span><span class="token plain"> house</span></div><div class="token-line"><span class="token plain">      dog</span><span class="token punctuation">.</span><span class="token property-access">girlFriend</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;charm&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      dog</span><span class="token punctuation">.</span><span class="token property-access">single</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _house </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      dog</span><span class="token punctuation">.</span><span class="token property-access">girlFriend</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      dog</span><span class="token punctuation">.</span><span class="token property-access">single</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">dog</span><span class="token punctuation">.</span><span class="token property-access">house</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;villa&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// {</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">//   name: &#x27;dog&#x27;,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">//   single: false,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">//   girlFriend: &#x27;charm&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// }</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">dog</span><span class="token punctuation">.</span><span class="token property-access">house</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// {</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">//   name: &#x27;dog&#x27;,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">//   single: true,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">//   girlFriend: null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// }</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>看起数据劫持很好用，但是其中也有许多需要注意的问题</p><h2 id="深入"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#深入"><span class="icon,icon-link"></span></a>深入</h2><h3 id="objectdefineproperty-的局限"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#objectdefineproperty-的局限"><span class="icon,icon-link"></span></a>Object.defineProperty 的局限</h3><h4 id="1-不能检测新增、删除属性操作"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#1-不能检测新增、删除属性操作"><span class="icon,icon-link"></span></a>1. 不能检测新增、删除属性操作</h4><p>Object.defineProperty 无法做到新增属性的拦截：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> dog </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">dog</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;dog&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>vue 官网中也提到:</p><blockquote><p>Vue 无法检测 property 的添加或移除。由于 Vue 会在初始化实例时对 property 执行 getter/setter 转化，所以 property 必须在 <code>data</code> 对象上存在才能让 Vue 将它转换为响应式的。例如：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> vm </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  data</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    a</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// `vm.a` 是响应式的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">vm</span><span class="token punctuation">.</span><span class="token property-access">b</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// `vm.b` 是非响应式的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></blockquote><p>因为无法劫持到 b 这个新增属性，所以即使视图中已经引用了 b ，视图也不会进行响应式的修改。 Vue 组件实例中提供了 <code>Vue.set</code> 方法来解决新增属性的问题。</p><p>Object.defineProperty 无法感知到已有属性的删除：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> dog </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token plain">dog</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;name&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  configurable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">get</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;dog&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">set</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">dog</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// &#x27;dog&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">delete</span><span class="token plain"> dog</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">dog</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// undefined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>defineProperty 的 set 描述符并不能劫持到 delete 操作。所以在 vue 中提供一个 <code>Vue.delete</code> 方法来删除一个属性。</p><h4 id="2-不能检测数组"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#2-不能检测数组"><span class="icon,icon-link"></span></a>2. 不能检测数组</h4><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> dogs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token plain">dogs</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  configurable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token string">&#x27;easy&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">set</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token plain">dogs</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  configurable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token string">&#x27;poor&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">set</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">dogs</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token comment">// 2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">dogs</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token comment">// &#x27;easy&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">dogs</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token comment">// &#x27;poor&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>看起来通过 Object.defineProperty 配置的数组元素表现正常，那么试一试操作数据的方法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">dogs.push(&#x27;newdog&#x27;) // [&#x27;easy&#x27;, &#x27;poor&#x27;, &#x27;newdogs&#x27;]</span></div><div class="token-line"><span class="token plain">dogs.unshift(&#x27;newdog2&#x27;)</span></div><div class="token-line"><span class="token plain">// easy</span></div><div class="token-line"><span class="token plain">// newdog2</span></div><div class="token-line"><span class="token plain">// 4</span></div><div class="token-line"><span class="token plain">// [&#x27;easy&#x27;, &#x27;poor&#x27;, &#x27;poor&#x27;, &#x27;newdogs&#x27;]</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>从这个打印输出来看 push 方法没有问题，但是 unshift 方法却不符合预期；unshift 方法的内部应该是首先将第一个元素赋值给第二，第二个赋值给第三个，以此类推，然后将 newdog2 复制给第一个元素。不过这从原理上说得通的，毕竟我们只是对 index 为 0 和 1 的属性做拦截。</p><h4 id="3-使用-objectassign-需要注意"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#3-使用-objectassign-需要注意"><span class="icon,icon-link"></span></a>3. 使用 Object.assign 需要注意</h4><p>MDN 官网上提到 Object.assign 方法在执行的时候，并不会拷贝属性描述符到新对象，所以在执行过程中，属性描述符会丢失：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> dog </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token plain">dog</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;name&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  configurable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  enumerable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">get</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;dog&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">set</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> dogBackup </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> dog</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// { name: &#x27;dog&#x27; }</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">dogBackup</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;dogBackup&#x27;</span><span class="token plain"> </span><span class="token comment">// { name: &#x27;dogBackup&#x27; }</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="proxy"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#proxy"><span class="icon,icon-link"></span></a>Proxy</h3><p>Proxy 对象用于定义基本操作的自定义行为（如属性查找、赋值、枚举、函数调用等）；上述 Object.defineProperty 的局限都可以通过 Proxy 来解决：</p><h4 id="1-拦截对象的基本操作"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#1-拦截对象的基本操作"><span class="icon,icon-link"></span></a>1. 拦截对象的基本操作</h4><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> dog </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;dog&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  single</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  girlFriend</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  house</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> proxyDog </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token plain">dog</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">get</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> prop</span><span class="token punctuation">,</span><span class="token plain"> receiver</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 拦截查找操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> prop</span><span class="token punctuation">,</span><span class="token plain"> receiver</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">set</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> prop</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">,</span><span class="token plain"> receiver</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 拦截新增属性</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">		</span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> prop</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token known-class-name class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&#x27;Unknown type &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> prop</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 拦截复制操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">prop </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;house&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;girlFriend&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;charm&#x27;</span><span class="token punctuation">,</span><span class="token plain"> receiver</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;single&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"> receiver</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;girlFriend&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> receiver</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;single&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"> receiver</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> prop</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">,</span><span class="token plain"> receiver</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">deleteProperty</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token parameter punctuation">,</span><span class="token parameter"> prop</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 拦截删除</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">prop </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;house&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;girlFriend&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;single&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">		</span><span class="token keyword">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">deleteProperty</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> prop</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="2-拦截数组原型上的方法"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#2-拦截数组原型上的方法"><span class="icon,icon-link"></span></a>2. 拦截数组原型上的方法</h4><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> dogs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> proxyDog </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token plain">dogs</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">	</span><span class="token function">apply</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">targetFun</span><span class="token parameter punctuation">,</span><span class="token parameter"> ctx</span><span class="token parameter punctuation">,</span><span class="token parameter"> args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 拦截方法调用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Reflect</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token plain">targetFun</span><span class="token punctuation">,</span><span class="token plain"> ctx</span><span class="token punctuation">,</span><span class="token plain"> args</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">proxyDog</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token string">&#x27;easy&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="3-为什么-vue2-中不使用-proxy-呢？"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#3-为什么-vue2-中不使用-proxy-呢？"><span class="icon,icon-link"></span></a>3. 为什么 Vue2 中不使用 Proxy 呢？</h4><p>原因其实很简单，Proxy 的兼容性太差，很多浏览器不支持，比如 IE11。</p><p>熟悉了数据劫持，可以再来深入了解下 vue 是怎么做到数据驱动视图更新的。</p><h2 id="vue-原理"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#vue-原理"><span class="icon,icon-link"></span></a>Vue 原理</h2><h3 id="vue2-响应式原理"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#vue2-响应式原理"><span class="icon,icon-link"></span></a>Vue2 响应式原理</h3><p>我们可以从三个角度：变化侦测机制、收集依赖、异步更新来理解 Vue2 的响应式原理。</p><h4 id="1-变化侦测机制---数据劫持"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#1-变化侦测机制---数据劫持"><span class="icon,icon-link"></span></a>1. 变化侦测机制 - 数据劫持</h4><p>在实例化 vue 组件的时候，就会对组件的 props、data 进行 <code>defineReactive</code> ，这个方法是对 Object.defineProperty 的封装，主要做很核心的几件事情：</p><ol><li>实例化一个依赖管理类 Dep</li></ol><p>这是很重要的一点，对象的每个属性都会实例化一个 Dep 类，通过这个类来收集依赖，以及通知更新</p><ol start="2"><li>通过 Object.defineProperty 劫持 getter ，收集依赖</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">,</span><span class="token plain"> key</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  enumerable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  configurable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reactiveGetter</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> value </span><span class="token operator">=</span><span class="token plain"> getter </span><span class="token operator">?</span><span class="token plain"> getter</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> val</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      dep</span><span class="token punctuation">.</span><span class="token method function property-access">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">childOb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        childOb</span><span class="token punctuation">.</span><span class="token property-access">dep</span><span class="token punctuation">.</span><span class="token method function property-access">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token method function property-access">isArray</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">dependArray</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这里问题就来了，我们正常取值 <code>data.name</code> 或者 <code>this.name</code> ，会触发 <code>reactiveGetter</code> ，但是这时候 <code>Dep.target</code> 肯定是不存在的，只有当 <code>Dep.target</code> 存在的时候才进行依赖收集：<code>dep.depend()</code> 。那么什么时候 <code>Dep.target</code> 才存在呢？<code>dep.depend()</code> 方法又做了些什么事情呢？</p><ol start="3"><li>通过 Object.defineProperty 劫持 setter ，通知依赖更新</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">set</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reactiveSetter</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> value </span><span class="token operator">=</span><span class="token plain"> getter </span><span class="token operator">?</span><span class="token plain"> getter</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> val</span></div><div class="token-line"><span class="token plain">		</span><span class="token comment">// 判断是否需要更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newVal </span><span class="token operator">===</span><span class="token plain"> value </span><span class="token operator">||</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newVal </span><span class="token operator">!==</span><span class="token plain"> newVal </span><span class="token operator">&amp;&amp;</span><span class="token plain"> value </span><span class="token operator">!==</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">/* eslint-enable no-self-compare */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;production&#x27;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> customSetter</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// #7981: for accessor properties without setter</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">getter </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">setter</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">setter</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      setter</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">,</span><span class="token plain"> newVal</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      val </span><span class="token operator">=</span><span class="token plain"> newVal</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    childOb </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">shallow </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token plain">newVal</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 通知更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    dep</span><span class="token punctuation">.</span><span class="token method function property-access">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>reactiveSetter 所做的事情就比较简单，主要做了两件事：1. 判断值是否发生变化；2. 通知依赖更新</p><h4 id="2-收集依赖"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#2-收集依赖"><span class="icon,icon-link"></span></a>2. 收集依赖</h4><p>在收集依赖的过程中，提出了两个问题：</p><p><strong>问题1：Dep.target 什么时候存在？</strong></p><p>首先 target 的类型是一个 <code>Watcher</code> 实例，在一个 vue 组件实例化的时候，会创建一个渲染 watcher ，渲染 watcher 是一个非惰性 watcher，实例化的的时候会立即将 Dep.target 设置成自己；</p><p>而在模版编译的时候，即 <code>vm._render</code> 函数执行，通过 <code>with</code> 的方式定义作用域为当前的组件：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token plain">code</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>with 语法通常在模版引擎使用，这样在模版编译的时候访问变量时的作用域，都是 with 指定的作用域，这样就可以触发对象属性的 <code>getter</code> 方法了。</p><blockquote><p>Dep.target 存在的条件可以认为是：需要数据来驱动更新；这在 Vue 中体现在：</p><ol><li>视图渲染</li><li>计算属性</li><li>$watch 方法</li></ol></blockquote><p><strong>问题2：<code>dep.depend</code> 方法做了什么事情？</strong></p><p>在对象属性的 getter 触发时，调用 <code>dep.depend()</code> 方法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Dep</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">	</span><span class="token function">depend</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token method function property-access">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="3-异步更新"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#3-异步更新"><span class="icon,icon-link"></span></a>3. 异步更新</h4><p>记得我刚开始接触 Vue 的时候，有人问我：vue 数据驱动视图更新是同步的还是异步的？如果是异步，怎么实现的？</p><p>很显然应该是异步的，在一个事件循环中多次执行数据更新操作，最终 dom 应该只需要渲染一次即可</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag">template</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">	</span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain">index</span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">template</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">script</span><span class="token tag punctuation">&gt;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript"></span><span class="token script language-javascript keyword module">export</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword module">default</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">{</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript function">data</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">{</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword">return</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">{</span><span class="token script language-javascript"> index</span><span class="token script language-javascript punctuation">:</span><span class="token script language-javascript"> </span><span class="token script language-javascript number">0</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">}</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">}</span><span class="token script language-javascript punctuation">,</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript function">mounted</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">{</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword">for</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript keyword">let</span><span class="token script language-javascript"> i</span><span class="token script language-javascript operator">=</span><span class="token script language-javascript number">0</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"> i</span><span class="token script language-javascript operator">&lt;</span><span class="token script language-javascript number">100</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"> i</span><span class="token script language-javascript operator">++</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">{</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword">this</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript property-access">index</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> i</span></div><div class="token-line"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation">}</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation">}</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript"></span><span class="token script language-javascript punctuation">}</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">script</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在数据更新时会触发 <code>dep.notify</code> ，这会将 watcher 放入队列等待下一次事件循环</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// observer/index.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">defineReactive</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">set</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      dep</span><span class="token punctuation">.</span><span class="token method function property-access">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// dep.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Dep</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">	</span><span class="token function">notify</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// stabilize the subscriber list first</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> subs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subs</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;production&#x27;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">config</span><span class="token punctuation">.</span><span class="token property-access">async</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// subs aren&#x27;t sorted in scheduler if not running async</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// we need to sort them now to make sure they fire in correct</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// order</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      subs</span><span class="token punctuation">.</span><span class="token method function property-access">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token parameter punctuation">,</span><span class="token parameter"> b</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> a</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> b</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> l </span><span class="token operator">=</span><span class="token plain"> subs</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> l</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      subs</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// watcher.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Watcher</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">update</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">/* istanbul ignore else */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">lazy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dirty</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sync</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>queueWatcher 会将当前 watcher push 到更新队列中，然后开始异步更新，以及更新后调触发响应的生命周期事件</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">queueWatcher</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">	</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token plain">flushSchedulerQueue</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">flushSchedulerQueue</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> index </span><span class="token operator">&lt;</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> index</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    watcher </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   	watcher</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">		</span><span class="token keyword">const</span><span class="token plain"> vm </span><span class="token operator">=</span><span class="token plain"> watcher</span><span class="token punctuation">.</span><span class="token property-access">vm</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">.</span><span class="token property-access">_watcher</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> watcher </span><span class="token operator">&amp;&amp;</span><span class="token plain"> vm</span><span class="token punctuation">.</span><span class="token property-access">_isMounted</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">vm</span><span class="token punctuation">.</span><span class="token property-access">_isDestroyed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;updated&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="细节处理"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#细节处理"><span class="icon,icon-link"></span></a>细节处理</h3><h3 id="对数组的处理"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#对数组的处理"><span class="icon,icon-link"></span></a>对数组的处理</h3><p>如果监听的 一个对象是一个数组，那么：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> hasProto </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;__proto__&#x27;</span><span class="token plain"> </span><span class="token keyword">in</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Observer</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token parameter punctuation">:</span><span class="token parameter"> any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">hasProto</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        value</span><span class="token punctuation">.</span><span class="token property-access">__proto__</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> arrayMethods</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">observeArray</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">walk</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">observeArray</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> l</span><span class="token operator">=</span><span class="token plain">value</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">&lt;</span><span class="token plain">l</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">walk</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> keys </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">&lt;</span><span class="token plain">keys</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">,</span><span class="token plain"> keys</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="proxy-在-vue3-中的运用"><a aria-hidden="true" tabindex="-1" href="/principle/reactive_vue#proxy-在-vue3-中的运用"><span class="icon,icon-link"></span></a>Proxy 在 Vue3 中的运用</h3><p>// TODO</p></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="Last update: ">2020-8-24 19:54:34</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="https://hm.baidu.com/hm.js?56fbe606b14d07f8ad321f2c766e4d29"></script>
    <script src="/umi.af893a71.js"></script>
  </body>
</html>
