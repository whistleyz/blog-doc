<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.jpg" />
    <link rel="stylesheet" href="/umi.79bb87e3.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.3.3
    </script>
    <title>Promise 规范与实现</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/principle/promise" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.jpg&#x27;)" href="/">blog-doc</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/summary">Summary</a></span><span><a href="/practice">Practice</a></span><span><a aria-current="page" class="active" href="/principle">Principle</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/whistleyz">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.jpg&#x27;)" href="/"></a><h1>blog-doc</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/summary">Summary</a></li><li><a href="/practice">Practice</a></li><li><a aria-current="page" class="active" href="/principle">Principle</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/whistleyz">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">Front</a><ul><li><a href="/principle/reactive_vue"><span>深入了解 vue 响应式原理</span></a></li><li><a href="/principle/state_manager"><span>实现一个前端状态管理器</span></a></li><li><a href="/principle/vue_computed"><span>Vue computed 与记忆函数</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">ECMAScript</a><ul><li><a aria-current="page" class="active" href="/principle/promise"><span>Promise 规范与实现</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="规范" data-depth="2"><a href="/principle/promise#规范"><span>规范</span></a></li><li title="1 Terminology" data-depth="3"><a href="/principle/promise#1-terminology"><span>1 Terminology</span></a></li><li title="2 Requirements" data-depth="3"><a href="/principle/promise#2-requirements"><span>2 Requirements</span></a></li><li title="实现" data-depth="2"><a href="/principle/promise#实现"><span>实现</span></a></li><li title="基本框架" data-depth="3"><a href="/principle/promise#基本框架"><span>基本框架</span></a></li><li title="模拟任务队列" data-depth="3"><a href="/principle/promise#模拟任务队列"><span>模拟任务队列</span></a></li><li title="发布订阅处理异步回调" data-depth="3"><a href="/principle/promise#发布订阅处理异步回调"><span>发布订阅处理异步回调</span></a></li><li title="Promise 状态更新" data-depth="3"><a href="/principle/promise#promise-状态更新"><span>Promise 状态更新</span></a></li><li title="调用 Promise.then callback" data-depth="3"><a href="/principle/promise#调用-promisethen-callback"><span>调用 Promise.then callback</span></a></li><li title="静态方法" data-depth="3"><a href="/principle/promise#静态方法"><span>静态方法</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="promise-规范与实现"><a aria-hidden="true" tabindex="-1" href="/principle/promise#promise-规范与实现"><span class="icon,icon-link"></span></a>Promise 规范与实现</h1><h2 id="规范"><a aria-hidden="true" tabindex="-1" href="/principle/promise#规范"><span class="icon,icon-link"></span></a>规范</h2><blockquote><p>规范地址：https://promisesaplus.com/</p></blockquote><h3 id="1-terminology"><a aria-hidden="true" tabindex="-1" href="/principle/promise#1-terminology"><span class="icon,icon-link"></span></a>1 Terminology</h3><ol><li><p>&#x27;promise&#x27; is an object or function with a <code>then</code> method whose behavior conforms to this specification.</p></li><li><p>&#x27;thenabale&#x27; is an object or function that defines a <code>then</code> method.</p></li><li><p>&#x27;value&#x27; is any legal Javascript value (including undefined, a thenable, or a promise).</p></li><li><p>&#x27;exception&#x27; is a value that is thrown using the throw statement.</p></li><li><p>&#x27;reason&#x27; is a value that indicates why a promise was rejected.</p></li></ol><h3 id="2-requirements"><a aria-hidden="true" tabindex="-1" href="/principle/promise#2-requirements"><span class="icon,icon-link"></span></a>2 Requirements</h3><h4 id="21-promise-state"><a aria-hidden="true" tabindex="-1" href="/principle/promise#21-promise-state"><span class="icon,icon-link"></span></a>2.1 Promise state</h4><p>A promise must be in one of three states: pending, fulfilled, or rejected.</p><h4 id="22-then"><a aria-hidden="true" tabindex="-1" href="/principle/promise#22-then"><span class="icon,icon-link"></span></a>2.2 then</h4><p>2.2.4 <code>onFulFilled</code> or <code>onRejected</code> must not be called until the execution context stack contains only platform code.</p><blockquote><p>这里指的是当 Promise state 发生改变， then 方法接收的 <code>onFulFilled</code> 和 <code>onRejected</code> 回调方法会在下一轮事件循环中被调用。</p><p>示例：即使 Promise 的状态立即被 resolve ，then 中的回调函数也不会立即执行</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 2. 后输出</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">456</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 1. 先输出</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></blockquote><p>2.2.6 <code>then</code> may be called multiple times on the same promise</p><blockquote><p>同一个 promise 的 then 方法可以调用多次</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> asyncVal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token string">&#x27;123&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">asyncVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 123</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">asyncVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 123</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">asyncVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 123</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></blockquote><p>2.2.7 <code>then</code> must return a promise.</p><blockquote><p>then 方法调用会返回一个新的 Promise</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> promise1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> promise2 </span><span class="token operator">=</span><span class="token plain"> promise1</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> val </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">promise2 </span><span class="token operator">===</span><span class="token plain"> promise1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">promise2</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></blockquote><p>2.2.7.3 If <code>onFulfilled</code> is not a function and <code>promise1</code> is fulfilled, <code>promise2</code> must be fufilled with the same value as <code>promise1</code></p><blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">	</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></blockquote><p>2.2.7.4 If <code>onRejected</code> is not a function and <code>promise1</code> is rejected, <code>promise2</code> must be rejected with <code>e</code> as the reason</p><blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;error&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">catch</span><span class="token punctuation">(</span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// Error: error</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></blockquote><h4 id="23-the-promise-resolution-procedure"><a aria-hidden="true" tabindex="-1" href="/principle/promise#23-the-promise-resolution-procedure"><span class="icon,icon-link"></span></a>2.3 The Promise Resolution Procedure</h4><h2 id="实现"><a aria-hidden="true" tabindex="-1" href="/principle/promise#实现"><span class="icon,icon-link"></span></a>实现</h2><h3 id="基本框架"><a aria-hidden="true" tabindex="-1" href="/principle/promise#基本框架"><span class="icon,icon-link"></span></a>基本框架</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">PENDING_STATE</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;pending&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">FULFILLED_STATE</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;resolved&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">REJECTED_STATE</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;rejected&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">resolver</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token plain">resolver</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">throwUnexpectResolver</span><span class="token punctuation">(</span><span class="token plain">resolver</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token plain"> </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">throwUnexpectContrust</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">promiseState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">PENDING_STATE</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">promiseValue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_subscribePromises</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">promiseResolve</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">promiseReject</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> error</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">resolver</span><span class="token punctuation">(</span><span class="token plain">promiseResolve</span><span class="token punctuation">,</span><span class="token plain"> promiseReject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> error</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token function">then</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">onFulfillment</span><span class="token parameter punctuation">,</span><span class="token parameter"> onRejction</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> thenPromise </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token plain">noop</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    thenPromise</span><span class="token punctuation">.</span><span class="token property-access">_onFulfillment</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> onFulfillment</span></div><div class="token-line"><span class="token plain">    thenPromise</span><span class="token punctuation">.</span><span class="token property-access">_onRejction</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> onRejction</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">promiseState</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">PENDING_STATE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> thenPromise</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">invokePromise</span><span class="token punctuation">(</span><span class="token plain">thenPromise</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">promiseValue</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> thenPromise</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">all</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">all</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">race</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">race</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reject</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">throwUnexpectResolver</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">resolver</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Promise resolver </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">resolver</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> is not a function.</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">throwUnexpectContrust</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Failed to construct &#x27;Promise&#x27;, please use new operator</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="模拟任务队列"><a aria-hidden="true" tabindex="-1" href="/principle/promise#模拟任务队列"><span class="icon,icon-link"></span></a>模拟任务队列</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">microTimeFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">fn</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> process</span><span class="token punctuation">.</span><span class="token method function property-access">nextTick</span><span class="token punctuation">(</span><span class="token plain">fn</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> jobs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> pending </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">flush</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> jobsCopied </span><span class="token operator">=</span><span class="token plain"> jobs</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  jobs</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  pending </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> jobs</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    jobs</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">nextTick</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  jobs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">fn</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">pending</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    pending </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">microTimeFunc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="发布订阅处理异步回调"><a aria-hidden="true" tabindex="-1" href="/principle/promise#发布订阅处理异步回调"><span class="icon,icon-link"></span></a>发布订阅处理异步回调</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">subscribe</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token parameter punctuation">,</span><span class="token parameter"> thenPromise</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> subscribePromises </span><span class="token operator">=</span><span class="token plain"> promise</span><span class="token punctuation">.</span><span class="token property-access">_subscribePromises</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  subscribePromises</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">thenPromise</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">PENDING_STATE</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">subscribePromises</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">publish</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> subscribePromises </span><span class="token operator">=</span><span class="token plain"> promise</span><span class="token punctuation">.</span><span class="token property-access">_subscribePromises</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> length </span><span class="token operator">=</span><span class="token plain"> subscribePromises</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> thenPromise </span><span class="token operator">=</span><span class="token plain"> subscribePromises</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">invokePromise</span><span class="token punctuation">(</span><span class="token plain">thenPromise</span><span class="token punctuation">,</span><span class="token plain"> promise</span><span class="token punctuation">.</span><span class="token property-access">promiseState</span><span class="token punctuation">,</span><span class="token plain"> promise</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  subscribePromises</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="promise-状态更新"><a aria-hidden="true" tabindex="-1" href="/principle/promise#promise-状态更新"><span class="icon,icon-link"></span></a>Promise 状态更新</h3><h4 id="promise-onfulfillment"><a aria-hidden="true" tabindex="-1" href="/principle/promise#promise-onfulfillment"><span class="icon,icon-link"></span></a>Promise onFulfillment</h4><ol><li>Promise 的状态更新为 FULFILLED_STATE</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// inernal: resolve(this, value)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">cannotResolveSelf</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&#x27;You cannot resovle a promise with itself&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token parameter punctuation">,</span><span class="token parameter"> value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promise </span><span class="token operator">===</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token function">cannotResolveSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 2.3.1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token function">fulfill</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">fulfill</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token parameter punctuation">,</span><span class="token parameter"> value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">.</span><span class="token property-access">promiseState</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">PENDING_STATE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  promise</span><span class="token punctuation">.</span><span class="token property-access">promiseValue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">  promise</span><span class="token punctuation">.</span><span class="token property-access">promiseState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">FULFILLED_STATE</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">.</span><span class="token property-access">_subscribePromises</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="2"><li>处理 resolve 一个 promise 的情况</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> p </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">p</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token parameter punctuation">,</span><span class="token parameter"> value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promise </span><span class="token operator">===</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token function">cannotResolveSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 2.3.1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isThenable</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">handleForeignThenable</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">fulfill</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">handleForeignThenable</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token parameter punctuation">,</span><span class="token parameter"> thenValue</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> sealed </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> error </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      thenValue</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">onThenFulfillment</span><span class="token punctuation">,</span><span class="token plain"> onThenRejection</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      error </span><span class="token operator">=</span><span class="token plain"> err</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">onThenFulfillment</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">sealed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span></div><div class="token-line"><span class="token plain">      sealed </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isThenable</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">				</span><span class="token function">fulfill</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">onThenRejection</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">sealed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span></div><div class="token-line"><span class="token plain">      sealed </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span></div><div class="token-line"><span class="token plain">      </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> error</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="promise-onrejection"><a aria-hidden="true" tabindex="-1" href="/principle/promise#promise-onrejection"><span class="icon,icon-link"></span></a>Promise onRejection</h4><ol><li>Promise 的状态更新为 REJECTED_STATE</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reject</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token parameter punctuation">,</span><span class="token parameter"> error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">	</span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">.</span><span class="token property-access">promiseState</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">PENDING_STATE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    promise</span><span class="token punctuation">.</span><span class="token property-access">promiseState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">REJECTED_STATE</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    promise</span><span class="token punctuation">.</span><span class="token property-access">promiseValue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> error</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="调用-promisethen-callback"><a aria-hidden="true" tabindex="-1" href="/principle/promise#调用-promisethen-callback"><span class="icon,icon-link"></span></a>调用 Promise.then callback</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">invokeThenPromise</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">thenPromise</span><span class="token parameter punctuation">,</span><span class="token parameter"> promiseState</span><span class="token parameter punctuation">,</span><span class="token parameter"> promiseValue</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> callback</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promiseState </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">FULFILL_STATE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    callback </span><span class="token operator">=</span><span class="token plain"> thenPromise</span><span class="token punctuation">.</span><span class="token property-access">onFulfill</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promiseState </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">REJECTION_STATE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    callback </span><span class="token operator">=</span><span class="token plain"> thenPromise</span><span class="token punctuation">.</span><span class="token property-access">onReject</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token plain">callback</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> thenResult </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token plain">promiseValue</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">thenPromise</span><span class="token punctuation">,</span><span class="token plain"> thenResult</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">thenPromise</span><span class="token punctuation">,</span><span class="token plain"> error</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promiseState </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">FULFILL_STATE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">fulfill</span><span class="token punctuation">(</span><span class="token plain">thenPromise</span><span class="token punctuation">,</span><span class="token plain"> promiseValue</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">promiseState </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">REJECTION_STATE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">thenPromise</span><span class="token punctuation">,</span><span class="token plain"> promiseValue</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="静态方法"><a aria-hidden="true" tabindex="-1" href="/principle/promise#静态方法"><span class="icon,icon-link"></span></a>静态方法</h3><h4 id="promiseall"><a aria-hidden="true" tabindex="-1" href="/principle/promise#promiseall"><span class="icon,icon-link"></span></a>Promise.all</h4><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">all</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">		</span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> len </span><span class="token operator">=</span><span class="token plain"> promises</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> index </span><span class="token operator">&lt;</span><span class="token plain"> len</span><span class="token punctuation">;</span><span class="token plain"> index</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token known-class-name class-name">Promise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">promises</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          result</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token plain">count </span><span class="token operator">===</span><span class="token plain"> len </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">.</span><span class="token method function property-access">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        	</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain">    </span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="promiserace"><a aria-hidden="true" tabindex="-1" href="/principle/promise#promiserace"><span class="icon,icon-link"></span></a>Promise.race</h4><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">race</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> len </span><span class="token operator">=</span><span class="token plain"> promise</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> len</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="promiseresolve"><a aria-hidden="true" tabindex="-1" href="/principle/promise#promiseresolve"><span class="icon,icon-link"></span></a>Promise.resolve</h4><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> promise </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token plain">noop</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> promise</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="promisereject"><a aria-hidden="true" tabindex="-1" href="/principle/promise#promisereject"><span class="icon,icon-link"></span></a>Promise.reject</h4><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> promise </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token plain">noop</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">promise</span><span class="token punctuation">,</span><span class="token plain"> error</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> promise</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="Last update: ">2020-8-24 19:54:34</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="https://hm.baidu.com/hm.js?56fbe606b14d07f8ad321f2c766e4d29"></script>
    <script src="/umi.af893a71.js"></script>
  </body>
</html>
