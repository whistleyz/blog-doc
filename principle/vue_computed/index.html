<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.jpg" />
    <link rel="stylesheet" href="/umi.79bb87e3.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.3.3
    </script>
    <title>Vue computed 与记忆函数</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/principle/vue_computed" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.jpg&#x27;)" href="/">blog-doc</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/summary">Summary</a></span><span><a href="/practice">Practice</a></span><span><a aria-current="page" class="active" href="/principle">Principle</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/whistleyz">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.jpg&#x27;)" href="/"></a><h1>blog-doc</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/summary">Summary</a></li><li><a href="/practice">Practice</a></li><li><a aria-current="page" class="active" href="/principle">Principle</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/whistleyz">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">Front</a><ul><li><a href="/principle/reactive_vue"><span>深入了解 vue 响应式原理</span></a></li><li><a href="/principle/state_manager"><span>实现一个前端状态管理器</span></a></li><li><a aria-current="page" class="active" href="/principle/vue_computed"><span>Vue computed 与记忆函数</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">ECMAScript</a><ul><li><a href="/principle/promise"><span>Promise 规范与实现</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="1 背景" data-depth="2"><a href="/principle/vue_computed#1-背景"><span>1 背景</span></a></li><li title="2 记忆函数" data-depth="2"><a href="/principle/vue_computed#2-记忆函数"><span>2 记忆函数</span></a></li><li title="3 Vue computed" data-depth="2"><a href="/principle/vue_computed#3-vue-computed"><span>3 Vue computed</span></a></li><li title="3.1 基本用法" data-depth="3"><a href="/principle/vue_computed#31-基本用法"><span>3.1 基本用法</span></a></li><li title="3.2 原理" data-depth="3"><a href="/principle/vue_computed#32-原理"><span>3.2 原理</span></a></li><li title="4 总结" data-depth="2"><a href="/principle/vue_computed#4-总结"><span>4 总结</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="vue-computed-与记忆函数"><a aria-hidden="true" tabindex="-1" href="/principle/vue_computed#vue-computed-与记忆函数"><span class="icon,icon-link"></span></a>Vue computed 与记忆函数</h1><h2 id="1-背景"><a aria-hidden="true" tabindex="-1" href="/principle/vue_computed#1-背景"><span class="icon,icon-link"></span></a>1 背景</h2><p>假设有以下一段代码，render 方法的参数 c 是经常变化的，而 a、b 则变化不频繁。分析这段代码可以得出一个结论：每次 render 函数被调用都会触发 calc 函数的调用，如果 a、b 参数没有发生改变，那么就会增加没有必要的计算。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">calc</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token parameter punctuation">,</span><span class="token parameter"> b</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;calc&#x27;</span><span class="token punctuation">,</span><span class="token plain"> a</span><span class="token punctuation">,</span><span class="token plain"> b</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 复杂的计算</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> a </span><span class="token operator">**</span><span class="token plain"> b</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">render</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token parameter punctuation">,</span><span class="token parameter"> b</span><span class="token parameter punctuation">,</span><span class="token parameter"> c</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;render&#x27;</span><span class="token punctuation">,</span><span class="token plain"> a</span><span class="token punctuation">,</span><span class="token plain"> b</span><span class="token punctuation">,</span><span class="token plain"> c</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    status</span><span class="token punctuation">:</span><span class="token plain"> c </span><span class="token operator">%</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    result</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token function">calc</span><span class="token punctuation">(</span><span class="token plain">a</span><span class="token punctuation">,</span><span class="token plain"> b</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>解决这种问题的方法有很多，相信聪明的你已经想出来用缓存的方法可以解决这样的问题；这里介绍给大家 Memoize Function 一种解决问题的思路。</p><h2 id="2-记忆函数"><a aria-hidden="true" tabindex="-1" href="/principle/vue_computed#2-记忆函数"><span class="icon,icon-link"></span></a>2 记忆函数</h2><p>其原理是通过对函数参数、计算结果进行缓存，再次调用进行比较：如果参数发生了变化，那么需要进行重新计算；如果参数没有发生变化，则返回上一次的计算结果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createMemo</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">targetFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> lastArgs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> lastResult </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 通过一个闭包函数缓存参数和运算结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter operator">...</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">argumentsShallowlyEqual</span><span class="token punctuation">(</span><span class="token plain">lastArgs</span><span class="token punctuation">,</span><span class="token plain"> args</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">			lastResult </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">targetFunc</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    lastArgs </span><span class="token operator">=</span><span class="token plain"> args</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> lastResult</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 判断引用相等即可</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">argumentsShallowlyEqual</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">prev</span><span class="token parameter punctuation">,</span><span class="token parameter"> next</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">prev </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> next </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> prev</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> next</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> length </span><span class="token operator">=</span><span class="token plain"> prev</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">&lt;</span><span class="token plain">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">prev</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> next</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>现在将 calc 方法封装一下再进行测试，结果是符合预期的：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">calc </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createMemo</span><span class="token punctuation">(</span><span class="token plain">calc</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">render</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// render 1 2 3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// calc 1 2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">render</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// render 1 2 3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">render</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// render 2 2 3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// calc 2 2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">render</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// render 2 2 3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>不过简单的缓存并不能 cover 住复杂的 Redux 应用程序，还需要对 createMemo 方法进行进一步拓展。比如我们有以下 redux 相关代码片段，我们希望在原有逻辑改动不大的情况下，引入记忆函数来优化性能：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> state </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  filter</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;done&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  todos</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    status</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;done&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    status</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;doing&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">getTodos</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">state</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">todos</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">getFilter</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">state</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">filter</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">getDoingTodos</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">filter</span><span class="token parameter punctuation">,</span><span class="token parameter"> todos</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> todos</span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> item</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> filter</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>记忆函数应该支持组合的，这样在 redux 应用中，不修改代码基本就可以完成优化：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> getDoingTodos </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createMemo</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">state</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">getFilter</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">state</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">getTodos</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">(</span><span class="token parameter">filter</span><span class="token parameter punctuation">,</span><span class="token parameter"> todos</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> todos</span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> item</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> filter</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>所以还需要再来修改一下 createMemo 方法以支持组合的情况：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createMemo</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter operator">...</span><span class="token parameter">funcs</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> targetFunc </span><span class="token operator">=</span><span class="token plain"> funcs</span><span class="token punctuation">.</span><span class="token method function property-access">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dependencies </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token spread operator">...</span><span class="token plain">funcs</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">	</span><span class="token keyword">const</span><span class="token plain"> memoizedTargetFunc </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">defaultMemoize</span><span class="token punctuation">(</span><span class="token plain">targetFunc</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> selector </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">defaultMemoize</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter operator">...</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> params </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> length </span><span class="token operator">=</span><span class="token plain"> dependencies</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">&lt;</span><span class="token plain">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      params</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">dependencies</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token function">memoizedTargetFunc</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">params</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> selector</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">defaultMemoize</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> lastArgs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> lastResult </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter operator">...</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">argumentsShallowlyEqual</span><span class="token punctuation">(</span><span class="token plain">lastArgs</span><span class="token punctuation">,</span><span class="token plain"> args</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      lastResult </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">func</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    lastArgs </span><span class="token operator">=</span><span class="token plain"> args</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> lastResult</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 判断引用相等即可</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">argumentsShallowlyEqual</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">prev</span><span class="token parameter punctuation">,</span><span class="token parameter"> next</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">prev </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> next </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> prev</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> next</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> length </span><span class="token operator">=</span><span class="token plain"> prev</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">&lt;</span><span class="token plain">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">prev</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> next</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这里要注意的是，createMemo 我们创建了两个 &#x27;memoize&#x27; 的函数，selector 缓存的参数是 <code>status</code> ，memoizedTargetFunc 缓存的参数是 <code>filter</code> 、<code>todos</code> 。由于记忆函数在 argumentsShallowlyEqual 函数中判断参数是否发生改变，仅仅是进行 <code>ShallowlyEqual</code> 。所以，想要进一步判断相等，可能还需要引入不可变数据 (immutable.js) 、重置 argumentsShallowlyEqual 等。</p><blockquote><p>参考</p><p>Redux 计算衍生数据：https://www.redux.org.cn/docs/recipes/ComputingDerivedData.html</p><p>Reselect <a target="_blank" rel="noopener noreferrer" href="https://github.com/reduxjs/reselect">https://github.com/reduxjs/reselect<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><p>在 Vue 中也有计算属性能达到类似效果，他们在实现上和用法都有一些不同。在 Redux 中，需要缓存的函数可能都需要用 createMemo 方法封装一下，例如示例中，如果 getTodos 方法也需要进行大量计算，那么还需要对 getTodos 方法套个记忆函数的壳，而 Vue 自带计算属性，一个 computed 就可以实现类似的能力。</p><h2 id="3-vue-computed"><a aria-hidden="true" tabindex="-1" href="/principle/vue_computed#3-vue-computed"><span class="icon,icon-link"></span></a>3 Vue computed</h2><h3 id="31-基本用法"><a aria-hidden="true" tabindex="-1" href="/principle/vue_computed#31-基本用法"><span class="icon,icon-link"></span></a>3.1 基本用法</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Demo1</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  template</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;&lt;div&gt;{{b}}&lt;/div&gt;&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">data</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      a</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  computed</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">b</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> a </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>相信你对上面的代码再熟悉不过了，现在进行简单修改，如果计算属性依赖的路径过多，那么你知道它在 Vue 中如何被更新的吗？</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Demo2</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  template</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;&lt;div&gt;{{b}}{{c}}&lt;/div&gt;&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">data</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      a</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  computed</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">b</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;b&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> a </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">c</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;c&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> b </span><span class="token operator">+</span><span class="token plain"> a</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>如果这时候改变 a ，那么 c 、b 计算属性中各打印几次 ？</p><h3 id="32-原理"><a aria-hidden="true" tabindex="-1" href="/principle/vue_computed#32-原理"><span class="icon,icon-link"></span></a>3.2 原理</h3><p>实例化一个 Vue 组件大致经历以下过程，从下面的简化代码可以看出，计算属性 computed 主要在 initComputed 方法中初始化。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// https://github.com/vuejs/vue/blob/dev/src/core/instance/index.js#L8</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Vue</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_init</span><span class="token punctuation">(</span><span class="token plain">options</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">_init</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// https://github.com/vuejs/vue/blob/dev/src/core/instance/init.js#L52</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">initLifecycle</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">initEvents</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">initRender</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;beforeCreate&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">initInjections</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// resolve injections before data/props</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// https://github.com/vuejs/vue/blob/dev/src/core/instance/state.js#L48</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">initState</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  vm</span><span class="token punctuation">.</span><span class="token property-access">_watchers</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> opts </span><span class="token operator">=</span><span class="token plain"> vm</span><span class="token punctuation">.</span><span class="token property-access">$options</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">opts</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">initProps</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> opts</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">opts</span><span class="token punctuation">.</span><span class="token property-access">methods</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">initMethods</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> opts</span><span class="token punctuation">.</span><span class="token property-access">methods</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">opts</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">initData</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">.</span><span class="token property-access">_data</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">opts</span><span class="token punctuation">.</span><span class="token property-access">computed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">initComputed</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> opts</span><span class="token punctuation">.</span><span class="token property-access">computed</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">opts</span><span class="token punctuation">.</span><span class="token property-access">watch</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> opts</span><span class="token punctuation">.</span><span class="token property-access">watch</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> nativeWatch</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">initWatch</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> opts</span><span class="token punctuation">.</span><span class="token property-access">watch</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>那么 initComputed 方法做了哪些事情呢 ？</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> computedWatcherOptions </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> lazy</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">initComputed</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token parameter punctuation">:</span><span class="token parameter"> Component</span><span class="token parameter punctuation">,</span><span class="token parameter"> computed</span><span class="token parameter punctuation">:</span><span class="token parameter"> Object</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// $flow-disable-line</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> watchers </span><span class="token operator">=</span><span class="token plain"> vm</span><span class="token punctuation">.</span><span class="token property-access">_computedWatchers</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// computed properties are just getters during SSR</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> isSSR </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">const</span><span class="token plain"> key </span><span class="token keyword">in</span><span class="token plain"> computed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> userDef </span><span class="token operator">=</span><span class="token plain"> computed</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> getter </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> userDef </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> userDef </span><span class="token punctuation">:</span><span class="token plain"> userDef</span><span class="token punctuation">.</span><span class="token property-access">get</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;production&#x27;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> getter </span><span class="token operator">==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Getter is missing for computed property &quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">key</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">&quot;.</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        vm</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">isSSR</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// create internal watcher for the computed property.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      watchers</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        vm</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        getter </span><span class="token operator">||</span><span class="token plain"> noop</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        noop</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        computedWatcherOptions</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// component-defined computed properties are already defined on the</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// component prototype. We only need to define computed properties defined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// at instantiation here.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token plain">key </span><span class="token keyword">in</span><span class="token plain"> vm</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">defineComputed</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> key</span><span class="token punctuation">,</span><span class="token plain"> userDef</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;production&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">key </span><span class="token keyword">in</span><span class="token plain"> vm</span><span class="token punctuation">.</span><span class="token property-access">$data</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">The computed property &quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">key</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">&quot; is already defined in data.</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"> vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">.</span><span class="token property-access">$options</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> key </span><span class="token keyword">in</span><span class="token plain"> vm</span><span class="token punctuation">.</span><span class="token property-access">$options</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">The computed property &quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">key</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">&quot; is already defined as a prop.</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"> vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>阅读上面的代码之后可以发现，在 computed 初始化阶段主要做了两件事情：</p><ol><li>遍历每个属性，为每个属性实例化一个 <code>lazy</code> Watcher</li><li>为每个属性 defineComputed</li></ol><p>Watcher 的实例化稍微有点复杂，待会再说，先往下走，看看 defineComputed 做了什么事情。</p><h4 id="321-definecomputed"><a aria-hidden="true" tabindex="-1" href="/principle/vue_computed#321-definecomputed"><span class="icon,icon-link"></span></a>3.2.1 defineComputed</h4><p>这个过程很简单，类似于将一个对象 defineReactive 。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> sharedPropertyDefinition </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  enumerable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  configurable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">get</span><span class="token punctuation">:</span><span class="token plain"> noop</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">set</span><span class="token punctuation">:</span><span class="token plain"> noop</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">defineComputed</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">target</span><span class="token parameter punctuation">:</span><span class="token parameter"> any</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  key</span><span class="token parameter punctuation">:</span><span class="token parameter"> string</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  userDef</span><span class="token parameter punctuation">:</span><span class="token parameter"> Object </span><span class="token parameter operator">|</span><span class="token parameter"> Function</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> shouldCache </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">!</span><span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> userDef </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    sharedPropertyDefinition</span><span class="token punctuation">.</span><span class="token property-access">get</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> shouldCache</span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function">createComputedGetter</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token function">createGetterInvoker</span><span class="token punctuation">(</span><span class="token plain">userDef</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    sharedPropertyDefinition</span><span class="token punctuation">.</span><span class="token property-access">set</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> noop</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    sharedPropertyDefinition</span><span class="token punctuation">.</span><span class="token property-access">get</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> userDef</span><span class="token punctuation">.</span><span class="token property-access">get</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> shouldCache </span><span class="token operator">&amp;&amp;</span><span class="token plain"> userDef</span><span class="token punctuation">.</span><span class="token property-access">cache</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function">createComputedGetter</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token function">createGetterInvoker</span><span class="token punctuation">(</span><span class="token plain">userDef</span><span class="token punctuation">.</span><span class="token property-access">get</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">:</span><span class="token plain"> noop</span></div><div class="token-line"><span class="token plain">    sharedPropertyDefinition</span><span class="token punctuation">.</span><span class="token property-access">set</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> userDef</span><span class="token punctuation">.</span><span class="token property-access">set</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> noop</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> key</span><span class="token punctuation">,</span><span class="token plain"> sharedPropertyDefinition</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createComputedGetter</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">computedGetter</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> watcher </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_computedWatchers</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_computedWatchers</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">watcher</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">watcher</span><span class="token punctuation">.</span><span class="token property-access">dirty</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        watcher</span><span class="token punctuation">.</span><span class="token method function property-access">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        watcher</span><span class="token punctuation">.</span><span class="token method function property-access">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> watcher</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这里主要关注 computedGetter 方法，在这之前，先来了解一下 watcher 的几个属性方法，后面会详细去说：</p><ul><li>watcher.dirty 是标记 watcher 是否需要重新求值，当计算属性的依赖发生变化时 dirty 会被赋值为 true ，因为需要重新进行 watcher.evaluate</li><li>watcher.evaluate 所做的事情就是求值，即运行 userDef 函数，求值完成后将 dirty 赋值为 false</li><li>watcher.depend 依赖当前的 Dep.target，比如当前正在处于渲染过程中，Darget.target 为渲染 watcher ，那么当前计算属性的 watcher 会被渲染 watcher 收集，这样计算属性作为渲染 watcher 的一个依赖，所以计算属性改变会触发渲染 watcher 更新</li></ul><p>获取计算属性的值时，会触发 computedGetter 方法，首次调用会触发 watcher.evalute 计算，这中间会有依赖收集的过程；计算完成后，会进行值的缓存，那么计算属性再次被调用就不会触发求值。</p><p>到这里你可能有点懵懂，实际上 Watcher 是计算属性实现的关键，像要了解计算属性，必须要深入 Watcher 的实现。</p><h4 id="322-lazy-watcher"><a aria-hidden="true" tabindex="-1" href="/principle/vue_computed#322-lazy-watcher"><span class="icon,icon-link"></span></a>3.2.2 lazy Watcher</h4><p>经简化后， Watcher 与计算属性相关的部分源代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// https://github.com/vuejs/vue/blob/dev/src/core/observer/watcher.js#L26</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Watcher</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token parameter">vm</span><span class="token parameter punctuation">:</span><span class="token parameter"> Component</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">    expOrFn</span><span class="token parameter punctuation">:</span><span class="token parameter"> string </span><span class="token parameter operator">|</span><span class="token parameter"> Function</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">    cb</span><span class="token parameter punctuation">:</span><span class="token parameter"> Function</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">    options</span><span class="token parameter operator">?</span><span class="token parameter punctuation">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter">Object</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">    isRenderWatcher</span><span class="token parameter operator">?</span><span class="token parameter punctuation">:</span><span class="token parameter"> boolean</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">		</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">vm</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> vm</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">lazy</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain">options</span><span class="token punctuation">.</span><span class="token property-access">lazy</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">		</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dirty</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">lazy</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">getter</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> expOrFn</span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// lazy watcher 不立即求值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">lazy</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">get</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">    value </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">getter</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">deep</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token plain">value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token function">update</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">/* istanbul ignore else */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 计算属性的依赖发生更新时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">lazy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dirty</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sync</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 计算属性取值时触发</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">evaluate</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dirty</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>可以分三个过程来解释这部分代码：Watcher 实例化过程、计算属性取值过程、依赖更新过程</p><ol><li>计算属性初始化 即 Watcher 实例化过程</li></ol><p>initComputed 在遍历计算属性的过程中，实例化 watcher 时， lazy 会被赋值为 true ，即实例化了一个 <code>lazy</code> Watcher 如果当前是一个 <code>lazy</code> Watcher 的话，那么不会立即去求值。</p><ol start="2"><li>计算属性取值过程</li></ol><p>当触发计算属性的 computedGetter 取值函数时，会调用 watcher.evaluate 方法，这个方法才真正的调用 getter 函数（也就是开发者定义的 computed 的函数）来计算结果，并将结果缓存到 watcher.value 中</p><p>当 watcher.get 被调用时，Dep.target 会变为当前这个计算属性的 watcher ，所以 this.getter 调用的时候，函数内部的所有依赖会被当前 watcher 收集。</p><blockquote><p>这里依赖收集的过程如果你不是很了解的话，推荐你看一下 Vue 源码中 observer 的过程，或者看一下我的另一篇相关的文章 <a target="_blank" rel="noopener noreferrer" href="https://blog.easydog.club/principle/reactive_vue#vue-%E5%8E%9F%E7%90%86">深入了解 vue 响应式原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><p>当 watcher.evaluate 调用完成后，dirty 会被立即设置为 false ，所以后续再触发计算属性的取值函数，则不会重新计算，这样就达到了缓存的效果。</p><ol start="3"><li>依赖更新的过程</li></ol><p>当计算属性的依赖更新时，会触发计算属性 watcher.update 方法，这里并不进行求值，仅仅是将当前的 dirty 赋值为 false ， 表明当前的 watcher 的依赖已经发生变化，那么下一次计算属性被调用时，就会触发重新求值。这里就解释了，当计算属性的依赖更新时，计算属性并不会立即重新计算，而是当调用的时候才会重新求值。</p><h2 id="4-总结"><a aria-hidden="true" tabindex="-1" href="/principle/vue_computed#4-总结"><span class="icon,icon-link"></span></a>4 总结</h2><p>先回答一下 3.1 节中提出的问题，当 a 改变了，c、b 各打印一次，而且 c、b 的求值时惰性的，如果模版里面没有依赖 b、c，他们是不会打印的。</p><p>以上，本文详细分析了记忆函数与 Vue 的计算属性，Vue 的计算属性很巧妙的结合 Vue 自身响应式特性实现，Redux 也是通过简单的记忆函数就能实现性能优化。</p></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="Last update: ">2020-7-30 14:52:35</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="https://hm.baidu.com/hm.js?56fbe606b14d07f8ad321f2c766e4d29"></script>
    <script src="/umi.af893a71.js"></script>
  </body>
</html>
